name: Bump version and publish to NPM

on:
  workflow_dispatch:
    inputs:

      is-main-release:
        required: true
        type: boolean
        description: Publish with the "latest" tag (NPM)
        default: 'false'

      tag-from-branch:
        required: true
        type: boolean
        description: '-prerelease suffix from branch name, rather than "-beta". Ignored for "latest" tag'
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: '16.x'
          registry-url: https://registry.npmjs.org/

      - run: echo is main release *${{github.event.inputs.is-main-release}}*
      - run: echo tag from branch *${{github.event.inputs.tag-from-branch}}*
      - run: echo ${{ !github.event.inputs.is-main-release && !github.event.inputs.tag-from-branch && 'beta' || 'no beta' }}
      - run: echo ${{ !github.event.inputs.is-main-release && github.event.inputs.tag-from-branch && 'branchname' || 'no branchname' }}

      - name: Publish main release (with "latest" tag)
        if: ${{ github.event.inputs.is-main-release }}
        run: |
          echo npm version patch

      - name: Publish prerelease (with "beta" tag and "-beta" suffix)
        if: ${{ !github.event.inputs.is-main-release && !github.event.inputs.tag-from-branch }}
        run: |
          echo npm version patch --preid=beta

      - name: Publish prerelease with branch suffix (with "beta" tag, "-branch-name" suffix)
        if: ${{ !github.event.inputs.is-main-release && github.event.inputs.tag-from-branch }}
        run: |
          echo npm version patch --preid=$(echo ${GITHUB_REF#refs/heads/}))

      #- run: npm publish --tag=${{ github.event.inputs.npm-tag }}

      #- run: npm run test
      #- run: npm version ${{ github.event.inputs.message }}
      #- run: npm run build
      #- run: npm publish
      #  env:
      #    NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
